# GitHub Actions Implementation Plan for SampleApp

**Goal:** Implement CI/CD GitHub Actions workflows for the `SampleApp` project by leveraging the reusable workflow templates from `InwardEcho/workflow-templates@main`.

**Key Decisions Based on Your Feedback:**

1.  **Terraform File Structure:** Workflow calls will be modified to use `SampleApp`'s existing structure:
    *   Terraform files in the `infra/` directory.
    *   Variable files like `infra/dev.tfvars`, `infra/test.tfvars`.
    *   Backend config files like `infra/dev.backend.hcl`.
2.  **Reusable Workflow References:** All references to `InwardEcho/workflow-templates` will use the `main` branch (e.g., `InwardEcho/workflow-templates/.github/workflows/workflow-name.yml@main`).
3.  **.NET EF Core Project Path:** The EF Core project for migrations is `src/SampleApp.WebApp/SampleApp.WebApp.csproj`.
4.  **NuGet Package Publishing:** `SampleApp` is not intended to be published as a NuGet package. The CI workflow's NuGet publishing step should be skipped or handled gracefully if no packages are produced.

---

### Phase 1: Create CI Workflow for `SampleApp`

1.  **Create `sampleapp-ci.yml`:**
    *   **File Path:** `.github/workflows/sampleapp-ci.yml` (in the `SampleApp` repository).
    *   **Purpose:** To define the Continuous Integration process for `SampleApp`.
    *   **Trigger:** On pushes to the `main` branch and any pull request targeting `main`.
    *   **Action:** This workflow will primarily be a caller to the `ci-unified.yml` reusable workflow.
    *   **Content Outline:**
        ```yaml
        name: SampleApp CI
        
        on:
          push:
            branches:
              - main
          pull_request:
            branches:
              - main
        
        jobs:
          call_unified_ci:
            name: Call Unified CI Workflow
            uses: InwardEcho/workflow-templates/.github/workflows/ci-unified.yml@main
            with:
              logLevel: 'info' # Or your preferred log level
              # solution_path: 'SampleApp.sln' # Optional: if different from default in reusable
              # dotnet_version_to_use: '8.0.x' # Optional: if different from default
            secrets:
              WORKFLOW_DISPATCH_PAT: ${{ secrets.WORKFLOW_DISPATCH_PAT }} # Required for triggering CD
              NUGET_FEED_AUTH_TOKEN_CI: ${{ secrets.NUGET_FEED_AUTH_TOKEN_CI }} # Optional
              SLACK_WEBHOOK_URL_CI: ${{ secrets.SLACK_WEBHOOK_URL_CI }} # Optional
        ```
    *   **Note on NuGet Publishing:** The `ci-unified.yml` template includes a job for publishing NuGet packages. Since `SampleApp` doesn't require this, we will rely on the conditional logic within `ci-unified.yml` and `reusable-publish-nuget.yml` to skip this step if no `.nupkg` files are generated by the build process.

---

### Phase 2: Create CD Workflow for `SampleApp`

1.  **Create `sampleapp-cd.yml`:**
    *   **File Path:** `.github/workflows/sampleapp-cd.yml` (in the `SampleApp` repository).
    *   **Purpose:** To define the Continuous Deployment process for `SampleApp`, orchestrating deployments to `dev`, `test`, and `prod` environments. This workflow will adapt the logic from `unified-cd-workflow.yml` to suit `SampleApp`'s specific needs, particularly for Terraform paths, while still calling the granular reusable workflows.
    *   **Trigger:** `workflow_dispatch` (will be triggered by `sampleapp-ci.yml` for `dev`, and then for promotions).
    *   **Structure:** This workflow will mirror the job structure of `unified-cd-workflow.yml` (e.g., `prepare_deployment_info`, `deploy_and_validate`, `trigger_next_stage`, `report_cd_status`).
    *   **Key Modifications in `deploy_and_validate` job:**
        *   **Call to `reusable-iac-terraform.yml`:**
            *   `uses: InwardEcho/workflow-templates/.github/workflows/reusable-iac-terraform.yml@main`
            *   `working-directory: 'infra'`
            *   `var-file: '${{ github.event.inputs.target_environment_type }}.tfvars'` (e.g., `dev.tfvars`)
            *   `backend-config-file: '${{ github.event.inputs.target_environment_type }}.backend.hcl'` (e.g., `dev.backend.hcl`)
            *   Other inputs like `terraform-command`, `environment`, `apply-auto-approve` will be passed as appropriate for the deployment stage.
        *   **Call to `reusable-database-migration-efcore.yml`:**
            *   `uses: InwardEcho/workflow-templates/.github/workflows/reusable-database-migration-efcore.yml@main`
            *   `efcore-project-path: 'src/SampleApp.WebApp/SampleApp.WebApp.csproj'`
            *   `connection-string: ${{ secrets.DB_CONNECTION_STRING }}` (scoped per GitHub Environment)
        *   Calls to `reusable-deploy-environment.yml` (for dev/test) and `reusable-canary-deployment.yml` (for prod) will be maintained, referencing `@main`.
        *   Calls to `reusable-observability-hooks.yml` will be maintained for notifications, referencing `@main`.
    *   **Inputs & Secrets:** Will require inputs like `version_to_deploy`, `source_artifact_name`, `target_environment_type`. Secrets like `WORKFLOW_DISPATCH_PAT`, cloud provider credentials (e.g., `AZURE_CLIENT_ID`, `AZURE_TENANT_ID`, `AZURE_SUBSCRIPTION_ID`, `AZURE_CLIENT_SECRET`), `DB_CONNECTION_STRING`, and `SLACK_WEBHOOK_URL` will need to be configured in `SampleApp` repository/environment settings.

---

### Phase 3: Configure GitHub Secrets and Variables

The following secrets and variables will need to be configured in the `SampleApp` GitHub repository settings and/or GitHub Environments (`Development`, `Test`, `Production`):

*   **Repository Secrets:**
    *   `WORKFLOW_DISPATCH_PAT`: A Personal Access Token with `workflow` scope to allow workflows to trigger other workflows (e.g., CI triggering CD, CD promoting to next environment).
    *   `NUGET_FEED_AUTH_TOKEN_CI` (Optional): If any private NuGet feeds are used during build.
    *   `SLACK_WEBHOOK_URL_CI` (Optional): For CI notifications.

*   **Environment Secrets (scoped to `Development`, `Test`, `Production` GitHub Environments):**
    *   `AZURE_CLIENT_ID`: Azure Service Principal Client ID for Terraform.
    *   `AZURE_CLIENT_SECRET`: Azure Service Principal Client Secret.
    *   `AZURE_SUBSCRIPTION_ID`: Azure Subscription ID.
    *   `AZURE_TENANT_ID`: Azure Tenant ID.
    *   `DB_CONNECTION_STRING`: Database connection string for EF Core migrations.
    *   `AZURE_CREDENTIALS_APP_SERVICE` (If deploying to Azure App Service): JSON credentials for Azure App Service deployment.
    *   `SLACK_WEBHOOK_URL` (Optional): For CD notifications, potentially different per environment.

*   **Environment Variables (configured in GitHub Variables, possibly scoped per environment):**
    *   `DEV_ENVIRONMENT_URL`, `TEST_ENVIRONMENT_URL`, `PROD_ENVIRONMENT_URL`: URLs for the deployed applications in each environment.
    *   `DEV_AZURE_APP_NAME`, `TEST_AZURE_APP_NAME`, `PROD_AZURE_APP_NAME`: Names of the Azure App Services (or equivalent) for each environment.
    *   `PROD_CANARY_PERCENTAGE` (e.g., `10`): Percentage of traffic for canary deployments.
    *   `PROD_CANARY_OBSERVATION_MINUTES` (e.g., `30`): Observation period for canary.
    *   `PROD_CANARY_HEALTH_CHECK_URL_PATTERN`: Health check URL for canary.
    *   (And potentially others as defined/needed by the reusable deployment workflows).

---

### Workflow Diagram

```mermaid
graph TD
    subgraph SampleApp Repository
        A[sampleapp-ci.yml] -- triggers on push/PR --> B{Call Unified CI};
        B -- uses --> C[InwardEcho/workflow-templates/.../ci-unified.yml@main];
        C -- calls --> C1[.../reusable-versioning.yml@main];
        C -- calls --> C2[.../reusable-build-test-dotnet.yml@main];
        C -- calls --> C3[.../reusable-publish-nuget.yml@main];
        C -- on success & dev target --> D{Trigger sampleapp-cd.yml for DEV};

        E[sampleapp-cd.yml] -- triggered by CI or promotion --> F{Prepare Deployment Info};
        F --> G{Deploy & Validate};
        G -- calls for IaC --> H[InwardEcho/workflow-templates/.../reusable-iac-terraform.yml@main];
        G -- calls for DB Migrations --> I[InwardEcho/workflow-templates/.../reusable-database-migration-efcore.yml@main];
        G -- calls for App Deploy (Dev/Test) --> J[InwardEcho/workflow-templates/.../reusable-deploy-environment.yml@main];
        G -- calls for App Deploy (Prod Canary) --> K[InwardEcho/workflow-templates/.../reusable-canary-deployment.yml@main];
        G -- on success & if promotion applicable --> L{Trigger Next Stage (self)};
        E -- calls for notifications --> M[InwardEcho/workflow-templates/.../reusable-observability-hooks.yml@main];
        C -- calls for notifications --> M;
    end

    style A fill:#lightgrey,stroke:#333,stroke-width:2px
    style E fill:#lightgrey,stroke:#333,stroke-width:2px
    style C fill:#lightblue,stroke:#333,stroke-width:2px
    style H fill:#lightblue,stroke:#333,stroke-width:2px
    style I fill:#lightblue,stroke:#333,stroke-width:2px
    style J fill:#lightblue,stroke:#333,stroke-width:2px
    style K fill:#lightblue,stroke:#333,stroke-width:2px
    style M fill:#lightblue,stroke:#333,stroke-width:2px
    style C1 fill:#lightblue,stroke:#333,stroke-width:2px
    style C2 fill:#lightblue,stroke:#333,stroke-width:2px
    style C3 fill:#lightblue,stroke:#333,stroke-width:2px